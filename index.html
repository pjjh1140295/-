<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>綠色生活地圖</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #map { height: 100%; width: 100%; z-index: 0; }
        
        /* 隱藏 Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* 簡約聚合圖示 (Cluster) */
        .unified-cluster {
            background: linear-gradient(135deg, #34d399 0%, #059669 100%);
            color: white;
            border-radius: 50%;
            text-align: center;
            font-weight: bold;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4);
            border: 2px solid white;
            transition: all 0.3s ease;
        }
        .unified-cluster:active { transform: scale(0.95); }

        /* 單點圖示樣式 */
        .custom-marker-pin {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            color: white;
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            font-size: 16px;
            transition: transform 0.2s;
        }

        /* 載入動畫 */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #10b981;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* PopUp 美化 */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 0;
            overflow: hidden;
        }
        .leaflet-popup-content {
            margin: 0;
            width: 280px !important;
        }
        
        .filter-chip { transition: all 0.2s; font-size: 0.9rem; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- 頂部狀態列 -->
    <div class="absolute top-4 left-4 right-4 z-[1000] flex justify-center pointer-events-none">
        <div id="status-pill" class="bg-white/95 backdrop-blur text-gray-700 px-4 py-2 rounded-full shadow-lg text-sm font-medium flex items-center gap-2 transition-all opacity-0 translate-y-[-20px]">
            <div id="loader-spinner" class="loader hidden"></div>
            <span id="status-text">就緒</span>
        </div>
    </div>

    <!-- 底部控制面板 -->
    <div class="absolute bottom-0 left-0 right-0 z-[1000] bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] p-5 pb-8 transition-transform duration-300 max-h-[60vh] overflow-y-auto no-scrollbar">
        
        <!-- 標題與按鈕 -->
        <div class="flex justify-between items-center mb-4 sticky top-0 bg-white z-10 pb-2">
            <h1 class="text-xl font-bold text-gray-800 flex items-center gap-1">
                <span class="text-green-600"><i class="fa-solid fa-leaf"></i></span>
                綠色地圖
            </h1>
            <button id="btn-locate" class="bg-green-600 hover:bg-green-700 text-white px-5 py-2.5 rounded-full text-sm font-bold shadow-lg shadow-green-200 active:scale-95 transition-all flex items-center gap-2">
                <i class="fa-solid fa-magnifying-glass"></i> 開始搜尋
            </button>
        </div>

        <!-- 篩選類別 -->
        <div id="filter-container" class="opacity-50 pointer-events-none transition-opacity duration-300">
            <div class="flex flex-wrap gap-2 justify-start" id="filter-scroll">
                <button onclick="toggleFilter('recycling')" class="filter-chip px-3 py-2 rounded-full font-medium bg-gray-100 text-gray-600 border border-gray-200" data-type="recycling">
                    <i class="fa-solid fa-recycle text-green-500 mr-1"></i> 回收站
                </button>
                
                <button onclick="toggleFilter('drinking_water')" class="filter-chip px-3 py-2 rounded-full font-medium bg-gray-100 text-gray-600 border border-gray-200" data-type="drinking_water">
                    <i class="fa-solid fa-faucet-drip text-blue-500 mr-1"></i> 飲水機
                </button>
                
                <button onclick="toggleFilter('toilets')" class="filter-chip px-3 py-2 rounded-full font-medium bg-gray-100 text-gray-600 border border-gray-200" data-type="toilets">
                    <i class="fa-solid fa-restroom text-gray-500 mr-1"></i> 廁所
                </button>
                
                <button onclick="toggleFilter('restaurant')" class="filter-chip px-3 py-2 rounded-full font-medium bg-gray-100 text-gray-600 border border-gray-200" data-type="restaurant">
                    <i class="fa-solid fa-utensils text-orange-500 mr-1"></i> 餐廳
                </button>

                <button onclick="toggleFilter('park')" class="filter-chip px-3 py-2 rounded-full font-medium bg-gray-100 text-gray-600 border border-gray-200" data-type="park">
                    <i class="fa-solid fa-tree text-emerald-600 mr-1"></i> 公園
                </button>

                <button onclick="toggleFilter('bicycle')" class="filter-chip px-3 py-2 rounded-full font-medium bg-gray-100 text-gray-600 border border-gray-200" data-type="bicycle">
                    <i class="fa-solid fa-bicycle text-yellow-600 mr-1"></i> 單車
                </button>

                <button onclick="toggleFilter('secondhand')" class="filter-chip px-3 py-2 rounded-full font-medium bg-gray-100 text-gray-600 border border-gray-200" data-type="secondhand">
                    <i class="fa-solid fa-shirt text-purple-500 mr-1"></i> 二手
                </button>
            </div>
            <div class="text-xs text-gray-400 mt-4 text-center border-t pt-2 border-gray-100">
                點擊類別可篩選 • 範圍 1 公里
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // --- 變數 ---
        let map, userMarker, userCircle, markerClusterGroup;
        let fetchedData = [];
        let currentFilter = 'all';
        const SEARCH_RADIUS = 1000;

        // UI 參考
        const statusPill = document.getElementById('status-pill');
        const statusText = document.getElementById('status-text');
        const loader = document.getElementById('loader-spinner');
        const btnLocate = document.getElementById('btn-locate');
        const filterContainer = document.getElementById('filter-container');

        // --- 初始化 ---
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([23.6, 121.0], 7);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OSM', maxZoom: 19
            }).addTo(map);

            markerClusterGroup = L.markerClusterGroup({
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                maxClusterRadius: 50,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = count > 99 ? 45 : 40;
                    return L.divIcon({
                        html: `<span>${count}</span>`,
                        className: 'unified-cluster',
                        iconSize: L.point(size, size)
                    });
                }
            });
            map.addLayer(markerClusterGroup);
        }

        // --- 定位 (移除所有 Demo/Fallback 邏輯) ---
        btnLocate.addEventListener('click', () => {
            showStatus('正在定位中...', true);
            
            if (!navigator.geolocation) { 
                showStatus('您的裝置不支援定位功能', false); 
                return; 
            }
            
            navigator.geolocation.getCurrentPosition(
                (pos) => handleLocationSuccess(pos.coords.latitude, pos.coords.longitude),
                (err) => {
                    console.error(err);
                    let msg = '定位失敗，請重試';
                    if (err.code === 1) msg = '請允許定位權限以使用此功能';
                    else if (err.code === 2) msg = '無法取得目前位置';
                    else if (err.code === 3) msg = '定位連線逾時';
                    
                    showStatus(msg, false);
                    // 這裡不再切換至演示點，直接停止
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        });

        function handleLocationSuccess(lat, lng) {
            showStatus('搜尋附近綠色據點...', true);
            map.setView([lat, lng], 16);

            if (userMarker) map.removeLayer(userMarker);
            if (userCircle) map.removeLayer(userCircle);

            const userIcon = L.divIcon({
                html: '<div class="w-4 h-4 bg-blue-500 border-2 border-white rounded-full shadow-md"></div>',
                className: '', iconSize: [16, 16]
            });

            userMarker = L.marker([lat, lng], {icon: userIcon}).addTo(map);
            userCircle = L.circle([lat, lng], {
                color: '#3b82f6', fillColor: '#3b82f6', fillOpacity: 0.05, weight: 1, radius: SEARCH_RADIUS
            }).addTo(map);

            filterContainer.classList.remove('opacity-50', 'pointer-events-none');
            fetchGreenSpots(lat, lng);
        }

        // --- 資料 ---
        async function fetchGreenSpots(lat, lng) {
            const query = `
                [out:json][timeout:25];
                (
                  nwr["amenity"="recycling"](around:${SEARCH_RADIUS},${lat},${lng});
                  nwr["amenity"="drinking_water"](around:${SEARCH_RADIUS},${lat},${lng});
                  nwr["amenity"="toilets"](around:${SEARCH_RADIUS},${lat},${lng});
                  nwr["diet:vegetarian"="yes"](around:${SEARCH_RADIUS},${lat},${lng});
                  nwr["diet:vegan"="yes"](around:${SEARCH_RADIUS},${lat},${lng});
                  nwr["leisure"="park"](around:${SEARCH_RADIUS},${lat},${lng});
                  nwr["leisure"="garden"](around:${SEARCH_RADIUS},${lat},${lng});
                  nwr["amenity"="bicycle_rental"](around:${SEARCH_RADIUS},${lat},${lng});
                  nwr["amenity"="charging_station"](around:${SEARCH_RADIUS},${lat},${lng});
                  nwr["shop"="second_hand"](around:${SEARCH_RADIUS},${lat},${lng});
                );
                out center; 
            `;

            try {
                const res = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query });
                const data = await res.json();
                processData(data.elements);
            } catch (e) {
                console.error(e);
                showStatus('資料載入失敗，請檢查網路', false);
            }
        }

        function processData(elements) {
            fetchedData = [];
            
            elements.forEach(el => {
                const lat = el.lat || el.center?.lat;
                const lng = el.lon || el.center?.lon;
                if (!lat || !lng) return;

                const tags = el.tags || {};
                let category = identifyCategory(tags);
                if (category === 'unknown') return;

                let displayName = tags.name;
                const op = tags.operator || tags.brand;
                const catName = getCategoryName(category);

                // 智慧命名邏輯
                if (!displayName) {
                    if (op) {
                        displayName = `${op} ${catName}`;
                    } else if (tags['addr:housename']) {
                        displayName = `${tags['addr:housename']} ${catName}`;
                    } else {
                        displayName = catName;
                    }
                }

                // 地址優化
                let address = '';
                if (tags['addr:city']) address += tags['addr:city'];
                if (tags['addr:district']) address += tags['addr:district'];
                if (tags['addr:street']) address += tags['addr:street'];
                if (tags['addr:housenumber']) address += tags['addr:housenumber'];
                if (!address && tags.location) address = tags.location;

                const details = {
                    phone: tags.phone || tags['contact:phone'],
                    website: tags.website || tags['contact:website'] || tags.facebook,
                    wheelchair: tags.wheelchair,
                    opening_hours: tags.opening_hours,
                    description: tags.description
                };

                fetchedData.push({
                    lat, lng, 
                    name: displayName, 
                    category, 
                    address, 
                    details,
                    style: getCategoryStyle(category)
                });
            });

            renderMarkers('all');
            
            if (fetchedData.length === 0) {
                showStatus('附近沒有找到相關地點', false);
            } else {
                showStatus(`找到 ${fetchedData.length} 個地點`, false);
                setTimeout(() => hideStatus(), 3000);
            }

            // 更新按鈕狀態：搜尋完成後，文字改為「重新搜尋」，圖示改為旋轉
            btnLocate.innerHTML = '<i class="fa-solid fa-rotate-right"></i> 重新搜尋';
        }

        // --- 邏輯與渲染 ---
        function toggleFilter(type) {
            if (currentFilter === type) {
                currentFilter = 'all';
            } else {
                currentFilter = type;
            }
            renderMarkers(currentFilter);
            updateFilterUI();
        }

        function updateFilterUI() {
            document.querySelectorAll('.filter-chip').forEach(btn => {
                if (currentFilter !== 'all' && btn.dataset.type === currentFilter) {
                    btn.classList.remove('bg-gray-100', 'text-gray-600', 'border-gray-200');
                    btn.classList.add('bg-gray-800', 'text-white', 'border-transparent');
                } else {
                    btn.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-200');
                    btn.classList.remove('bg-gray-800', 'text-white', 'border-transparent');
                }
            });
        }

        function renderMarkers(filterType) {
            markerClusterGroup.clearLayers();
            fetchedData.forEach(item => {
                if (filterType !== 'all' && item.category !== filterType) return;

                const style = item.style;
                const markerHtml = `<div class="custom-marker-pin ${style.color} w-10 h-10"><i class="fa-solid ${style.icon}"></i></div>`;
                
                const customIcon = L.divIcon({
                    html: markerHtml, className: '', iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -45]
                });

                let detailsHtml = '';
                if (item.address) detailsHtml += `<div class="text-sm text-gray-600 mb-1"><i class="fa-solid fa-location-dot w-4 text-center text-gray-400"></i> ${item.address}</div>`;
                if (item.details.opening_hours) detailsHtml += `<div class="text-sm text-green-600 mb-1"><i class="fa-regular fa-clock w-4 text-center"></i> ${item.details.opening_hours}</div>`;
                if (item.details.phone) detailsHtml += `<div class="text-sm text-blue-600 mb-1"><i class="fa-solid fa-phone w-4 text-center"></i> <a href="tel:${item.details.phone}">${item.details.phone}</a></div>`;
                if (item.details.website) detailsHtml += `<div class="text-sm text-blue-500 mb-1 truncate"><i class="fa-solid fa-globe w-4 text-center"></i> <a href="${item.details.website}" target="_blank">網站連結</a></div>`;
                if (item.details.wheelchair === 'yes') detailsHtml += `<div class="text-xs text-purple-600 mt-2 bg-purple-50 inline-block px-2 py-1 rounded"><i class="fa-solid fa-wheelchair"></i> 無障礙友善</div>`;

                const popupContent = `
                    <div class="flex flex-col">
                        <div class="bg-gray-50 p-3 border-b border-gray-100">
                            <h3 class="font-bold text-gray-800 text-base leading-tight">${item.name}</h3>
                            <span class="text-xs text-gray-500 mt-1 inline-block bg-white border px-2 py-0.5 rounded-full">${getCategoryName(item.category)}</span>
                        </div>
                        <div class="p-3">${detailsHtml || '<span class="text-gray-400 text-sm">無詳細資訊</span>'}</div>
                    </div>
                `;

                markerClusterGroup.addLayer(L.marker([item.lat, item.lng], { icon: customIcon }).bindPopup(popupContent));
            });
        }

        // 輔助函式
        function identifyCategory(tags) {
            if (tags.amenity === 'recycling') return 'recycling';
            if (tags.amenity === 'drinking_water') return 'drinking_water';
            if (tags.amenity === 'toilets') return 'toilets';
            if (tags['diet:vegetarian'] === 'yes' || tags['diet:vegan'] === 'yes') return 'restaurant';
            if (tags.leisure === 'park' || tags.leisure === 'garden') return 'park';
            if (tags.amenity === 'bicycle_rental' || tags.amenity === 'charging_station') return 'bicycle';
            if (tags.shop === 'second_hand') return 'secondhand';
            return 'unknown';
        }

        function getCategoryName(cat) {
            const map = { 'recycling': '回收站', 'drinking_water': '飲水機', 'toilets': '廁所', 'restaurant': '餐廳', 'park': '公園', 'bicycle': '交通', 'secondhand': '二手' };
            return map[cat] || '地點';
        }

        function getCategoryStyle(cat) {
            const styles = {
                'recycling': { color: 'bg-green-500', icon: 'fa-recycle' },
                'drinking_water': { color: 'bg-blue-500', icon: 'fa-faucet-drip' },
                'toilets': { color: 'bg-gray-500', icon: 'fa-restroom' },
                'restaurant': { color: 'bg-orange-500', icon: 'fa-utensils' },
                'park': { color: 'bg-emerald-600', icon: 'fa-tree' },
                'bicycle': { color: 'bg-yellow-500', icon: 'fa-bicycle' },
                'secondhand': { color: 'bg-purple-500', icon: 'fa-shirt' }
            };
            return styles[cat] || { color: 'bg-gray-400', icon: 'fa-map-pin' };
        }

        function showStatus(msg, isLoading) {
            statusPill.classList.remove('opacity-0', 'translate-y-[-20px]');
            statusPill.style.pointerEvents = 'auto';
            statusText.textContent = msg;
            loader.classList.toggle('hidden', !isLoading);
        }
        function hideStatus() {
            statusPill.classList.add('opacity-0', 'translate-y-[-20px]');
            statusPill.style.pointerEvents = 'none';
        }

        initMap();
    </script>
</body>
</html>
